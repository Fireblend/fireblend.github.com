
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />

<style id="webmakerstyle">
body {
  background: black;
  text-align: center;
  color: white;
}
canvas {
  border: 1px solid white;
}
a {
  color:#a4c2f4;
}
</style>
</head>
<body>
<canvas width="600" height="600"></canvas>
<div style="text-align: left">
<h2>Unnamed 17kb challenge game</h2>
This is a simple Javascript game developed using the <a href="https://straker.github.io/kontra/">Kontra micro-library</a>, intended to be under 17kb when zipped.

The game is a tribute to asymmetric 2-player games, such as <a href="http://www.spyparty.com/">Spy Party</a>.

<h2>Instructions</h2>
1 player plays as the <b>assassin</b> (keyboard) and another plays as the <b>sheriff</b> (mouse).<br><br>

The assassin's goal is to kill 3 villagers. To kill a villager, talk to them for 3 consecutive seconds (conversation happens automatically close to a villager), and then press the <i>space bar</i>.
<br>The screen will go dark after each kill to allow the assassin to escape the scene of the crime.

<br><br>

The sheriff's goal is to identify the assassin, and shoot them before they can accomplish their goal.

<script src="kontra.js"></script >
<script>
kontra.init();

let v1 = new Image();
let v2 = new Image();
let v3 = new Image();
let v4 = new Image();
v1.src = 'v1.png';
v2.src = 'v2.png';
v3.src = 'v3.png';
v4.src = 'v4.png';

let t1 = new Image();
let t2 = new Image();
let t3 = new Image();
t1.src = 't1.png';
t2.src = 't2.png';
t3.src = 't3.png';

let aim = new Image();
aim.src = 'aim.png';

s1 = new Audio('s1.wav');


let villagers = [];
let speechBubbles = [];

let blackFrames = -1;
let gameOver =false;
let deaths = 0;

var assassinIndicator = kontra.sprite({

  x: 100,
  y: 80,
  color: '#ffffff',
  active: true,
  startSeq: 60*5,
  active:true,

  render(){
    if(this.active){
      this.startSeq = this.startSeq -1
      if(this.startSeq == 0){
        this.active = false
      }
      this.context.strokeStyle = 'white';

      this.context.beginPath();
      this.context.moveTo(assassin.x+assassin.width/2, assassin.y+assassin.height/2 - 15);
      this.context.lineTo(assassin.x+assassin.width/2+10, assassin.y - 15);
      this.context.lineTo(assassin.x+assassin.width/2-10, assassin.y - 15);

      writeToScreenFull("Assassin", assassin.x-15, assassin.y-24, 11)

      this.context.closePath();
      this.context.stroke();
    }
  }
})

var assassin = kontra.sprite({
  id:28,
  x: 100,
  y: 80,
  color_list: [v1, v2, v3, v4],
  color: '#bad455',//this.color_list[Math.floor(Math.random()*this.color_list.length)],
  width: 20,
  height: 20,
  dead: false,
  running: false,
  talking: 0,
  who: null,

  init: function(){
    this.image = this.color_list[Math.floor(Math.random()*this.color_list.length)];
    this.x = 300
    this.y = 300
  },

  update(){
    if(this.dead){
      this.dx = 0;
      this.dy = 0;
    }

    else if(target.shot && !this.running && !this.dead){
      this.running = true
      if(kontra.pointer.x <= this.x){
          this.dx = 2
      }
      else{
          this.dx = -2
      }
      if(kontra.pointer.y <= this.y){
          this.dy = 2
      }
      else{
          this.dy = -2
      }
    }
    else if(!this.running && !this.dead){
      if (this.x > kontra.canvas.width-this.width/2) {
        this.x = -this.width/2;
      }
      else if (this.x < -this.width/2) {
        this.x = kontra.canvas.width-this.width/2;
      }
      if (this.y < -this.width/2) {
        this.y = kontra.canvas.height-this.width/2;
      }
      else if (this.y > kontra.canvas.height-this.width/2) {
        this.y = -this.width/2;
      }

      if (kontra.keys.pressed('up')) {
        this.dy = -1;
      }
      else if  (kontra.keys.pressed('down')){
        this.dy = 1;
      } else {
        this.dy = 0;
      }

      if (kontra.keys.pressed('left')) {
        this.dx = -1;
      }
      else if  (kontra.keys.pressed('right')){
        this.dx = 1;
      } else {
        this.dx = 0;
      }

      if (kontra.keys.pressed('space')){
          delta = (new Date()).getTime() - this.talking
          if(speechBubbles[this.id].active && delta > 3000 && this.who != null){
              villagers[this.who].dead = true
              blackFrames = 120
              deaths = deaths+1
              this.who = null
              s1.play()
          }
      }

      center_x = this.x-this.width/2
      center_y = this.y-this.width/2

      hide = true

      for (villager in villagers) {
        if(villagers[villager].id == this.id){
          continue
        }

        center_x2 = villagers[villager].x-villagers[villager].width/2
        center_y2 = villagers[villager].y-villagers[villager].width/2

        if(Math.abs(center_x-center_x2) < 30 && Math.abs(center_y-center_y2) < 30 ){
            if(speechBubbles[this.id].active==false){
              this.talking = (new Date()).getTime()
              this.who = villager
            }
            speechBubbles[this.id].active=true
            hide = false
            break
        }
      }
      if(hide){
        speechBubbles[this.id].active=false
        this.who = null
      }
    }
    this.advance()
  }
});

var target2 = kontra.sprite({
  color: "#ffffff",//this.color_list[Math.floor(Math.random()*this.color_list.length)],
  width: 1,
  height: 1,
  shot: false,

  update: function() {
    if(!target.shot){
      this.x = kontra.pointer.x
      this.y = kontra.pointer.y
    }
  },

  onDown: function() {
    if(assassin.x < kontra.pointer.x &&
      assassin.x+assassin.width >kontra.pointer.x &&
      assassin.y < kontra.pointer.y &&
      assassin.y+assassin.height > kontra.pointer.y){
        assassin.color = "#ff0000"
        assassin.dead = true

    }
    target.shot = true
    s1.play()
  }
});

var target = kontra.sprite({
  color: "#ffffff",//this.color_list[Math.floor(Math.random()*this.color_list.length)],
  image: aim,
  width: 80,
  height: 80,
  shot: false,

  update: function() {
    if(!this.shot){
      this.x = kontra.pointer.x-40
      this.y = kontra.pointer.y-40
    }
  }
});

kontra.pointer.track(target2);

function createVillager(vid) {
  let villager = kontra.sprite({
    id: vid,
    x: 100,
    y: 80,
    color_list: [v1, v2, v3, v4],
    color: '#bad455',//this.color_list[Math.floor(Math.random()*this.color_list.length)],
    width: 20,
    height: 20,
    dx: 1,
    frames: -1,
    moves: [-1, 0, 0, 1],
    running: false,

    init: function(){
      this.image = this.color_list[Math.floor(Math.random()*this.color_list.length)];
      this.x = Math.floor(Math.random()*600)
      this.y = Math.floor(Math.random()*600)
    },

    update(){
      // wrap the sprites position when it reaches
      // the edge of the screen

      if(target.shot && !this.running){
        speechBubbles[vid].active = false
        this.running = true
        if(kontra.pointer.x <= this.x){
            this.dx = 2
        }
        else{
            this.dx = -2
        }
        if(kontra.pointer.y <= this.y){
            this.dy = 2
        }
        else{
            this.dy = -2
        }
      }

      else if(!this.running){
        if (this.x > kontra.canvas.width-this.width/2) {
          this.x = -this.width/2;
        }
        if (this.x < -this.width/2) {
          this.x = kontra.canvas.width-this.width/2;
        }
        if (this.y < -this.width/2) {
          this.y = kontra.canvas.height-this.width/2;
        }
        if (this.y > kontra.canvas.height-this.width/2) {
          this.y = -this.width/2;
        }
        if(this.frames == -1){
          this.rerollMove()
        }
        this.frames = this.frames-1;
        if(this.frames <= 0){
          this.rerollMove()
        }
      }
      this.advance()
    },

    rerollMove: function() {
        this.dx = this.moves[Math.floor(Math.random()*this.moves.length)];
        this.dy = this.moves[Math.floor(Math.random()*this.moves.length)];
        this.frames = 10+Math.floor(Math.random()*100);
    },

    checkSpeech: function(villager){
      if(villager.id == this.id || this.dead){
        return false
      }

      center_x = this.x-this.width/2
      center_y = this.y-this.width/2

      center_x2 = villager.x-villager.width/2
      center_y2 = villager.y-villager.width/2

      if(Math.abs(center_x-center_x2) < 30 && Math.abs(center_y-center_y2) < 30 ){
        if(speechBubbles[this.id].active == false){
        }
        speechBubbles[this.id].active=true
        this.moves = [-1, 0, 0, 0, 0, 1]
        return true
      }
    },

    isTalking: function() {
      for (villager in villagers) {
        hide = true
        if(this.checkSpeech(villagers[villager])){
          break
        }
        if(hide == true){
          speechBubbles[this.id].active=false
          this.moves = [-1, 0, 0, 1]
        }
      }
      this.checkSpeech(assassin)
    }
  });
  villager.init();
  villagers.push(villager);
}

function createSpeechBubble(villager) {
  let speechBubble = kontra.sprite({
    x: 100,
    y: 80,
    image: t1,
    width: 40,
    height: 20,
    active: false,
    frames: 0,

    update(){
      if(this.active){
        if(this.frames > 60){
          this.frames = 0
        }else{
          this.frames++
        }
      } else {
        this.frames = 0
      }

      if(this.frames > 40){
        this.image = t3
      }
      else if(this.frames > 20){
        this.image = t2
      }
      else{
        this.image = t1
      }

      this.x = villager.x;
      this.y = villager.y-22;
    },

    render2(){
      if(this.active){
        this.render()
      }
    }

  });
  speechBubbles.push(speechBubble);
}

for (var i = 0; i < 28; i++) {
  createVillager(i);
  createSpeechBubble(villagers[i])
}
assassin.init();
createSpeechBubble(assassin)

function writeToScreen(text){
  writeToScreenFull(text, 50, 50, 25);
}

function writeToScreenFull(text, x, y, size){
  kontra.context.save()
  kontra.context.strokeStyle = "#ffffff"
  kontra.context.font = size + 'px Courier New'
  kontra.context.textBaseline = 'middle'
  kontra.context.fillStyle = "#ffffff"
  kontra.context.fillText(text, x, y)
  kontra.context.restore()
}

function fillScreen(color){

  kontra.context.beginPath();
  kontra.context.rect(0, 0, 600, 600);
  kontra.context.fillStyle = color;
  kontra.context.fill();
}

var loop = kontra.gameLoop({  // create the main game loop
  update() {        // update the game state
    assassin.update();
    target.update();
    target2.update();
    villagers.map(villager => {
      if(!villager.dead){
        villager.update();
      }
      villager.isTalking();
    })
    speechBubbles.map(speechBubble => {
      speechBubble.update();
    })
  },
  render() {        // render the game state
    fillScreen("#12d141")
    if(blackFrames <= 0){
      villagers.map(villager => {
        if(!villager.dead){
          villager.render()
        }});
      speechBubbles.map(bubble => bubble.render2());
      assassin.render();
      target.render();
      target2.render();
      assassinIndicator.render();
    } else {
      blackFrames = blackFrames-1
      fillScreen("#000000")
      writeToScreen("The assassin has struck!")
    }
    if(deaths == 3){
      writeToScreen("The assassin has won!")
    }
    if(target.shot){
      if(assassin.dead){
        writeToScreen("The assassin has been killed!")
      } else {
        writeToScreen("The assassin has escaped!")
      }
    }
  }

});

loop.start();    // start the game
//# sourceURL=userscript.js
</script>
</body>
</html>
